<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–∞—Ä–º–æ–Ω –ê–º–µ–ª–µ—Ö - 4 –ó–∞–ø–æ–≤–µ–¥–∏ –ü—É—Ä–∏–º–∞</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --burgundy: #4a0404;
            --gold: #d4af37;
            --parchment: #f4ebd0;
            --dark-gold: #aa8623;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            background-image: radial-gradient(circle, #2a2a2a 0%, #000000 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--parchment);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1, h2, h3 {
            text-align: center;
            color: var(--gold);
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .container {
            width: 90%;
            max-width: 800px;
            margin: 20px auto;
            background: var(--burgundy);
            border: 5px solid var(--gold);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.3);
            position: relative;
        }

        /* Gates UI */
        .gates-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .gate {
            width: 150px;
            height: 200px;
            background: linear-gradient(180deg, #3a0303 0%, #1a0101 100%);
            border: 3px solid #555;
            border-radius: 100px 100px 0 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
        }

        .gate.locked {
            border-color: #555;
        }

        .gate.unlocked {
            border-color: var(--gold);
            background: linear-gradient(180deg, #5a0505 0%, #2a0101 100%);
            box-shadow: 0 0 15px var(--gold);
        }
        
        .gate.completed {
            border-color: #27ae60;
            background: linear-gradient(180deg, #1e4b2e 0%, #0a1c11 100%);
        }

        .gate i.main-icon {
            font-size: 4rem;
            color: #555;
            margin-bottom: 15px;
            filter: drop-shadow(0 5px 5px #000);
        }

        .gate.unlocked i.main-icon { color: var(--gold); }
        .gate.completed i.main-icon { color: #27ae60; }

        .gate-title {
            font-weight: bold;
            font-size: 1.2rem;
            text-align: center;
            color: #888;
        }

        .gate.unlocked .gate-title { color: var(--parchment); }

        /* Scroll/Parchment UI */
        .scroll-container {
            display: none;
            background: var(--parchment);
            color: #333;
            padding: 30px;
            border-radius: 5px;
            border: 2px solid var(--dark-gold);
            box-shadow: inset 0 0 30px rgba(139, 69, 19, 0.3), 0 5px 15px rgba(0,0,0,0.5);
            margin-top: 20px;
            position: relative;
        }

        .scroll-container::before, .scroll-container::after {
            content: '';
            position: absolute;
            left: -10px;
            right: -10px;
            height: 15px;
            background: #8b4513;
            border-radius: 10px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.4);
        }
        .scroll-container::before { top: -10px; }
        .scroll-container::after { bottom: -10px; }

        .russian-text {
            font-size: 1.2rem;
            line-height: 1.6;
            text-align: left;
            direction: ltr;
            margin-bottom: 20px;
            font-family: Georgia, serif;
            border-bottom: 2px dashed #ccc;
            padding-bottom: 15px;
        }

        /* Task UI */
        .task-area {
            text-align: center;
            margin-top: 20px;
        }

        .items-grid {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .game-item {
            font-size: 3.5rem;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid transparent;
        }

        .game-item:hover {
            transform: scale(1.1);
        }

        .game-item.selected {
            color: var(--burgundy);
            border-color: var(--burgundy);
            background: rgba(212, 175, 55, 0.2);
            filter: drop-shadow(0 3px 3px rgba(0,0,0,0.2));
        }

        .btn {
            background: linear-gradient(to bottom, var(--gold), var(--dark-gold));
            color: var(--burgundy);
            border: none;
            padding: 10px 25px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            margin-top: 15px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            color: #888;
            cursor: not-allowed;
            transform: none;
        }

        /* Modals */
        #custom-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--burgundy);
            border: 3px solid var(--gold);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            color: var(--parchment);
            max-width: 400px;
            width: 90%;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
            direction: ltr; /* Keeping Russian modals LTR */
        }

        .modal-input {
            width: 80%;
            padding: 10px;
            margin: 15px 0;
            font-size: 1.2rem;
            border: 2px solid var(--gold);
            border-radius: 5px;
            background: var(--parchment);
            color: var(--burgundy);
            text-align: center;
        }

        /* Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: var(--gold);
            z-index: 999;
            animation: fall 3s linear forwards;
        }

        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); }
        }

        /* Unity End Screen */
        #end-screen {
            display: none;
            text-align: center;
            animation: fadeIn 2s ease;
        }

        .unity-word {
            font-size: 4rem;
            color: var(--gold);
            letter-spacing: 5px;
            margin: 20px 0;
            text-shadow: 0 0 20px var(--gold);
        }

        /* Wishes Board */
        .wishes-board {
            margin-top: 30px;
            background: rgba(244, 235, 208, 0.1);
            border: 1px solid var(--gold);
            border-radius: 10px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .wish-card {
            background: var(--parchment);
            color: var(--burgundy);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-right: 5px solid var(--gold);
            text-align: right;
            direction: rtl; /* User input is likely Hebrew or Russian */
        }

        .wish-author {
            font-weight: bold;
            font-size: 0.9rem;
            color: #8b4513;
        }

        .emoji-selector {
            font-size: 1.5rem;
            cursor: pointer;
            margin: 10px 0;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .emoji-selector span:hover {
            transform: scale(1.3);
        }

        #wait-message {
            display: none;
            text-align: center;
            color: var(--gold);
            font-size: 1.5rem;
            margin-top: 20px;
            padding: 20px;
            border: 2px dashed var(--gold);
            border-radius: 10px;
            background: rgba(0,0,0,0.5);
            direction: ltr;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

    </style>
</head>
<body>

    <div class="container" id="main-menu" style="direction: ltr;">
        <h1>–î–≤–æ—Ä–µ—Ü –¶–∞—Ä—è</h1>
        <h2>4 –ó–∞–ø–æ–≤–µ–¥–∏ –ü—É—Ä–∏–º–∞</h2>
        
        <div class="gates-container">
            <div class="gate locked" id="gate-1" onclick="attemptGate(1)">
                <i class="fas fa-scroll main-icon"></i>
                <div class="gate-title">–ß—Ç–µ–Ω–∏–µ –°–≤–∏—Ç–∫–∞</div>
            </div>
            <div class="gate locked" id="gate-2" onclick="attemptGate(2)">
                <i class="fas fa-utensils main-icon"></i>
                <div class="gate-title">–¢—Ä–∞–ø–µ–∑–∞</div>
            </div>
            <div class="gate locked" id="gate-3" onclick="attemptGate(3)">
                <i class="fas fa-box-open main-icon"></i>
                <div class="gate-title">–ú–∏—à–ª–æ–∞—Ö –º–∞–Ω–æ—Ç</div>
            </div>
            <div class="gate locked" id="gate-4" onclick="attemptGate(4)">
                <i class="fas fa-coins main-icon"></i>
                <div class="gate-title">–ü–æ–¥–∞—Ä–∫–∏ –±–µ–¥–Ω—ã–º</div>
            </div>
        </div>

        <div id="wait-message">
            <i class="fas fa-hourglass-half" style="margin-bottom: 10px;"></i><br>
            –ú–´ –ñ–î–ï–ú –£–ö–ê–ó–ê–ù–ò–ô –û–¢ –£–ß–ò–¢–ï–õ–Ø...
        </div>

        <div class="scroll-container" id="scroll-area" style="direction: ltr;">
            <h2 id="scroll-title" style="color: var(--burgundy);"></h2>
            <div class="russian-text" id="scroll-text"></div>
            
            <div class="task-area">
                <h3 style="color: var(--burgundy);">–ó–∞–¥–∞–Ω–∏–µ:</h3>
                <p style="color: #333; font-weight: bold;">–í—ã–±–µ—Ä–∏—Ç–µ 2 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–∞ —Å–æ–≥–ª–∞—Å–Ω–æ —Ç–µ–∫—Å—Ç—É:</p>
                <div class="items-grid" id="items-grid">
                    </div>
                <button class="btn" id="check-btn" onclick="checkAnswer()" disabled>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="container" id="end-screen" style="direction: ltr;">
        <i class="fas fa-crown" style="font-size: 5rem; color: var(--gold); filter: drop-shadow(0 0 10px #d4af37);"></i>
        <div class="unity-word">–ï–î–ò–ù–°–¢–í–û</div>
        <h3>–ú–æ–ª–æ–¥—Ü—ã! –í—ã —É–∑–Ω–∞–ª–∏, —á—Ç–æ –≤—Å–µ –∑–∞–ø–æ–≤–µ–¥–∏ –≤–µ–¥—É—Ç –∫ –µ–¥–∏–Ω—Å—Ç–≤—É!</h3>
        
        <div style="background: var(--parchment); padding: 20px; border-radius: 10px; color: var(--burgundy); margin-top: 20px;">
            <h3>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø—É—Ä–∏–º—Å–∫–æ–µ –ø–æ–∂–µ–ª–∞–Ω–∏–µ –ø–æ–¥—Ä—É–≥–∞–º:</h3>
            <input type="text" id="student-name" class="modal-input" placeholder="–í–∞—à–µ –∏–º—è" style="width: 90%; direction: rtl;">
            
            <div class="emoji-selector" id="emoji-picker">
                <span onclick="addEmoji('üé≠')">üé≠</span>
                <span onclick="addEmoji('üëë')">üëë</span>
                <span onclick="addEmoji('üç∑')">üç∑</span>
                <span onclick="addEmoji('üéÅ')">üéÅ</span>
                <span onclick="addEmoji('‚ú®')">‚ú®</span>
            </div>
            
            <textarea id="student-wish" class="modal-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –ø–æ–∂–µ–ª–∞–Ω–∏–µ –∑–¥–µ—Å—å..." rows="3" style="width: 90%; direction: rtl;"></textarea>
            <br>
            <button class="btn" onclick="submitWish()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–∂–µ–ª–∞–Ω–∏–µ <i class="fas fa-paper-plane"></i></button>
        </div>

        <div class="wishes-board" id="wishes-board">
            <h3 style="color: var(--gold);">–ö–ª–∞—Å—Å–Ω–∞—è –¥–æ—Å–∫–∞ –ø–æ–∂–µ–ª–∞–Ω–∏–π</h3>
            <div id="wishes-list" style="direction: rtl;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∂–µ–ª–∞–Ω–∏–π...</div>
        </div>
    </div>

    <div id="custom-modal">
        <div class="modal-content">
            <i id="modal-icon" class="fas fa-key" style="font-size: 3rem; color: var(--gold); margin-bottom: 15px;"></i>
            <h2 id="modal-title">–í–≤–µ–¥–∏ –∫–æ–¥</h2>
            <p id="modal-text">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –≤—Ä–∞—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –ø–æ–ª—É—á–∏–ª–∏ –æ—Ç —É—á–∏—Ç–µ–ª—è:</p>
            <input type="text" id="modal-input" class="modal-input" dir="ltr">
            <br>
            <button class="btn" id="modal-btn-1" style="display: none;"></button>
            <button class="btn" id="modal-btn-2" style="background: #666;"></button>
        </div>
    </div>

    <script>
        // Game Data with Full Russian Texts
        const gatesData = {
            1: {
                title: "–ß—Ç–µ–Ω–∏–µ –°–≤–∏—Ç–∫–∞ –≠—Å—Ç–µ—Ä",
                text: "–î–≤–∞–∂–¥—ã –≤ –ü—É—Ä–∏–º, –≤–µ—á–µ—Ä–æ–º –∏ –¥–Ω–µ–º, —á–∏—Ç–∞—é—Ç –ú–µ–≥–∏–ª–∞—Ç –≠—Å—Ç–µ—Ä (–°–≤–∏—Ç–æ–∫ –≠—Å—Ç–µ—Ä). –í –Ω–µ–º –æ–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ß—É–¥–æ, –ø—Ä–æ–∏–∑–æ—à–µ–¥—à–µ–µ —Å –µ–≤—Ä–µ—è–º–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∞ –ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ü–∞—Ä—è –ê—Ö–∞—à–≤–µ—Ä–æ—à–∞. –ó–∞–ø–æ–≤–µ–¥—å –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –ø—É–±–ª–∏—á–Ω–æ–º —á—Ç–µ–Ω–∏–∏ —ç—Ç–æ–≥–æ —Å–≤–∏—Ç–∫–∞. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –µ–∂–µ–≥–æ–¥–Ω–æ –≤—Å–ø–æ–º–∏–Ω–∞—Ç—å –æ —Å–æ–±—ã—Ç–∏—è—Ö –ü—É—Ä–∏–º–∞, –∫–∞–∫ –∑–∞–ø–æ–≤–µ–¥–∞–Ω–æ –≤ —Å–∞–º–æ–º —Å–≤–∏—Ç–∫–µ: ¬´–ò –¥–Ω–∏ —ç—Ç–∏ –±—É–¥–µ—Ç–µ –≤—Å–ø–æ–º–∏–Ω–∞—Ç—å –∏ –æ—Ç–º–µ—á–∞—Ç—å –∏–∑ –ø–æ–∫–æ–ª–µ–Ω–∏—è –≤ –ø–æ–∫–æ–ª–µ–Ω–∏–µ... –∏ –ø–∞–º—è—Ç—å –æ –Ω–∏—Ö –Ω–µ —Å–æ—Ç—Ä–µ—Ç—Å—è —É –≤–∞—à–∏—Ö –ø–æ—Ç–æ–º–∫–æ–≤¬ª.",
                code: "8534",
                items: [
                    { id: "scroll", icon: "fa-scroll", correct: true },
                    { id: "sunmoon", icon: "fa-cloud-sun", correct: true }, 
                    { id: "car", icon: "fa-car", correct: false },
                    { id: "tree", icon: "fa-tree", correct: false }
                ]
            },
            2: {
                title: "–ü—Ä–∞–∑–¥–Ω–∏—á–Ω–∞—è —Ç—Ä–∞–ø–µ–∑–∞",
                text: "–í—Å–ø–æ–º–∏–Ω–∞—è –æ —Ç—Ä–µ—Ö –ø–∏—Ä–∞—Ö, –æ–ø–∏—Å–∞–Ω–Ω—ã—Ö –≤ –°–≤–∏—Ç–∫–µ –≠—Å—Ç–µ—Ä, –º—ã —É—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–Ω–µ–≤–Ω—É—é –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—É—é —Ç—Ä–∞–ø–µ–∑—É –≤ –ü—É—Ä–∏–º. –ê –∫ —Ç—Ä–µ–º –ø–∏—Ä–∞–º –æ—Ç–Ω–æ—Å—è—Ç—Å—è: –ü–∏—Ä, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —Ü–∞—Ä—å –ê—Ö–∞—à–≤–µ—Ä–æ—à –≤—ã–≥–Ω–∞–ª —Ü–∞—Ä–∏—Ü—É –í–∞—à—Ç–∏; –ø–∏—Ä, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –µ–≤—Ä–µ–∏ —Å–æ–≥—Ä–µ—à–∏–ª–∏ –ø—Ä–æ—Ç–∏–≤ —Å–≤–æ–∏—Ö —Ü–µ–Ω–Ω–æ—Å—Ç–µ–π; –∏ –ø—É—Ä–∏–º—Å–∫–∞—è –∏—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ø–∏—Ä–æ–º –≤ —á–µ—Å—Ç—å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –µ–≤—Ä–µ–π—Å–∫–æ–≥–æ –Ω–∞—Ä–æ–¥–∞. –í–∞–∂–Ω–æ —Ä–∞–¥–æ–≤–∞—Ç—å—Å—è, –ø–∏—Ç—å –≤–∏–Ω–æ –∏ –µ—Å—Ç—å –≤–∫—É—Å–Ω—É—é –µ–¥—É.",
                code: "0294",
                items: [
                    { id: "food", icon: "fa-utensils", correct: true },
                    { id: "wine", icon: "fa-wine-glass", correct: true },
                    { id: "book", icon: "fa-book", correct: false },
                    { id: "hammer", icon: "fa-hammer", correct: false }
                ]
            },
            3: {
                title: "–ú–∏—à–ª–æ–∞—Ö –º–∞–Ω–æ—Ç",
                text: "–í –°–≤–∏—Ç–∫–µ –≠—Å—Ç–µ—Ä –Ω–∞–ø–∏—Å–∞–Ω–æ, —á—Ç–æ –≤ –ü—É—Ä–∏–º –Ω—É–∂–Ω–æ —Å–æ–≤–µ—Ä—à–∏—Ç—å ¬´...–ø–æ—Å—ã–ª–∞–Ω–∏–µ —è—Å—Ç–≤ –≤ –¥–∞—Ä –¥—Ä—É–≥ –¥—Ä—É–≥—É¬ª. –í—ã–ø–æ–ª–Ω—è—è —ç—Ç—É –∑–∞–ø–æ–≤–µ–¥—å, –º—ã –ø—Ä–æ—è–≤–ª—è–µ–º –±—Ä–∞—Ç—Å–∫—É—é –∑–∞–±–æ—Ç—É –¥—Ä—É–≥ –æ –¥—Ä—É–≥–µ, —É–º–Ω–æ–∂–∞–µ–º —Ä–∞–¥–æ—Å—Ç—å –∏ –≤–µ—Å–µ–ª—å–µ. –ß—Ç–æ–±—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å —ç—Ç—É –∑–∞–ø–æ–≤–µ–¥—å, –Ω—É–∂–Ω–æ –ø–æ—Å–ª–∞—Ç—å –º–∏–Ω–∏–º—É–º –¥–≤–∞ –≤–∏–¥–∞ —É–≥–æ—â–µ–Ω–∏–π, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–∏–∑–Ω–æ—Å—è—Ç —Ä–∞–∑–Ω—ã–µ –±–ª–∞–≥–æ—Å–ª–æ–≤–µ–Ω–∏—è. –ù–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞–ø–∏—Ç–æ–∫ –∏ –ø–∏—Ä–æ–≥. –≠—Ç–∏ —É–≥–æ—â–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç–∞–∫–∏–º–∏, —á—Ç–æ–± –∏—Ö –º–æ–∂–Ω–æ –±—ã–ª–æ —Ç—É—Ç –∂–µ —Å—ä–µ—Å—Ç—å, —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–º—É —á–µ–ª–æ–≤–µ–∫—É.",
                code: "1738",
                items: [
                    { id: "gift", icon: "fa-box-open", correct: true },
                    { id: "cookie", icon: "fa-cookie", correct: true },
                    { id: "clock", icon: "fa-clock", correct: false },
                    { id: "key", icon: "fa-key", correct: false }
                ]
            },
            4: {
                title: "–ü–æ–¥–∞—Ä–∫–∏ –±–µ–¥–Ω—ã–º",
                text: "–ù–∞–≥–æ–≤–∞—Ä–∏–≤–∞—è —Ü–∞—Ä—é –ê—Ö–∞—à–≤–µ—Ä–æ—à—É –Ω–∞ –µ–≤—Ä–µ–µ–≤, –ê–º–∞–Ω, –µ–≥–æ —Å–æ–≤–µ—Ç–Ω–∏–∫, –≥–æ–≤–æ—Ä–∏—Ç: ¬´–ï—Å—Ç—å –æ–¥–∏–Ω –Ω–∞—Ä–æ–¥, —Ä–∞—Å—Å–µ—è–Ω–Ω—ã–π –∏ —Ä–∞–∑–±—Ä–æ—Å–∞–Ω–Ω—ã–π –º–µ–∂–¥—É –Ω–∞—Ä–æ–¥–∞–º–∏¬ª. –≠—Ç–∏–º –æ–Ω –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–µ—Ç, —á—Ç–æ —Å—Ä–µ–¥–∏ –Ω–∞—à–µ–≥–æ –Ω–∞—Ä–æ–¥–∞ –Ω–µ –±—ã–ª–æ –µ–¥–∏–Ω—Å—Ç–≤–∞. –°–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, —Ä–µ—Ü–µ–ø—Ç —Å–ø–∞—Å–µ–Ω–∏—è –æ—Ç –±–µ–¥ –¥–ª—è –µ–≤—Ä–µ–µ–≤ ‚Äî –±—ã—Ç—å –≤ —Ç–µ—Å–Ω–æ–π –∏ –≥–ª—É–±–æ–∫–æ–π —Å–≤—è–∑–∏ –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º. –≠—Å—Ç–µ—Ä –≥–æ–≤–æ—Ä–∏—Ç –ú–æ—Ä–¥–µ—Ö–∞—é: ¬´–ò–¥–∏, —Å–æ–±–µ—Ä–∏ –≤—Å–µ—Ö –µ–≤—Ä–µ–µ–≤¬ª. –î–∞–≤–∞—è –ø–æ–¥–∞—Ä–∫–∏ –±–µ–¥–Ω—ã–º, –º—ã –æ–±—ä–µ–¥–∏–Ω—è–µ–º—Å—è.",
                code: "4039",
                items: [
                    { id: "coins", icon: "fa-coins", correct: true },
                    { id: "help", icon: "fa-hands-helping", correct: true },
                    { id: "chair", icon: "fa-chair", correct: false },
                    { id: "star", icon: "fa-star", correct: false }
                ]
            }
        };

        let currentGate = 1;
        let selectedItems = [];
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyEI6h2X9vIQJpQ96sjhRDpotE7-e1KNV6YYss-_nUGORb8sI-uMU9pUI054Pou_S5Z/exec";
        const SHEET_NAME = "◊§◊¢◊ô◊ú◊ï◊™ ◊ë◊®◊ï◊°◊ô◊™ 4 ◊û◊¶◊ï◊ï◊™";

        window.onload = () => {
            updateGatesUI();
        };

        function updateGatesUI() {
            for (let i = 1; i <= 4; i++) {
                const gate = document.getElementById(`gate-${i}`);
                if (i < currentGate) {
                    gate.className = "gate completed";
                } else if (i === currentGate) {
                    gate.className = "gate unlocked";
                } else {
                    gate.className = "gate locked";
                }
            }
        }

        function showModal(title, text, showInput, btn1Text, btn1Func, btn2Text, btn2Func, iconClass) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-text').innerText = text;
            document.getElementById('modal-icon').className = `fas ${iconClass || 'fa-info-circle'}`;
            
            const input = document.getElementById('modal-input');
            input.style.display = showInput ? 'block' : 'none';
            input.value = '';

            const btn1 = document.getElementById('modal-btn-1');
            if (btn1Text) {
                btn1.style.display = 'inline-block';
                btn1.innerText = btn1Text;
                btn1.onclick = btn1Func;
            } else {
                btn1.style.display = 'none';
            }

            const btn2 = document.getElementById('modal-btn-2');
            if (btn2Text) {
                btn2.style.display = 'inline-block';
                btn2.innerText = btn2Text;
                btn2.onclick = () => { hideModal(); if(btn2Func) btn2Func(); };
            } else {
                btn2.style.display = 'none';
            }

            document.getElementById('custom-modal').style.display = 'flex';
        }

        function hideModal() {
            document.getElementById('custom-modal').style.display = 'none';
        }

        function attemptGate(gateNum) {
            if (gateNum > currentGate) {
                showModal("–ó–∞–ø–µ—Ä—Ç–æ!", "–≠—Ç–∏ –≤—Ä–∞—Ç–∞ –≤—Å—ë –µ—â—ë –∑–∞–ø–µ—Ä—Ç—ã. –í–∞–º –Ω—É–∂–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ.", false, null, null, "–ü–æ–Ω—è—Ç–Ω–æ", null, "fa-lock");
                return;
            }
            if (gateNum < currentGate) {
                showModal("–ó–∞–≤–µ—Ä—à–µ–Ω–æ", "–í—ã —É–∂–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏ —ç—Ç–æ—Ç —ç—Ç–∞–ø!", false, null, null, "–ù–∞–∑–∞–¥", null, "fa-check-circle");
                return;
            }

            // Ask for code
            showModal(
                "–ü–µ—á–∞—Ç—å –¶–∞—Ä—è", 
                "–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –≤—Ä–∞—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –ø–æ–ª—É—á–∏–ª–∏ –æ—Ç —É—á–∏—Ç–µ–ª—è:", 
                true, 
                "–û—Ç–∫—Ä—ã—Ç—å –≤—Ä–∞—Ç–∞", 
                () => checkCode(gateNum), 
                "–û—Ç–º–µ–Ω–∞", 
                null, 
                "fa-key"
            );
        }

        function checkCode(gateNum) {
            const inputCode = document.getElementById('modal-input').value.trim();
            if (inputCode === gatesData[gateNum].code) {
                hideModal();
                openGateGame(gateNum);
            } else {
                showModal("–û—à–∏–±–∫–∞", "–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥. –ü–æ—Å–ª—É—à–∞–π—Ç–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —É—á–∏—Ç–µ–ª—è –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞!", false, null, null, "–ù–∞–∑–∞–¥", null, "fa-times-circle");
            }
        }

        function openGateGame(gateNum) {
            document.getElementById('wait-message').style.display = 'none';
            document.getElementById('scroll-area').style.display = 'block';
            document.getElementById('scroll-title').innerText = gatesData[gateNum].title;
            document.getElementById('scroll-text').innerText = gatesData[gateNum].text;
            
            selectedItems = [];
            const grid = document.getElementById('items-grid');
            grid.innerHTML = '';
            
            // Shuffle items
            const items = [...gatesData[gateNum].items].sort(() => Math.random() - 0.5);
            
            items.forEach(item => {
                const iElem = document.createElement('i');
                iElem.className = `fas ${item.icon} game-item`;
                iElem.dataset.id = item.id;
                iElem.onclick = () => toggleItemSelection(iElem, item);
                grid.appendChild(iElem);
            });
            
            document.getElementById('check-btn').disabled = true;
        }

        function toggleItemSelection(elem, itemData) {
            if (elem.classList.contains('selected')) {
                elem.classList.remove('selected');
                selectedItems = selectedItems.filter(i => i.id !== itemData.id);
            } else {
                if (selectedItems.length >= 2) return; // Max 2
                elem.classList.add('selected');
                selectedItems.push(itemData);
            }
            
            document.getElementById('check-btn').disabled = (selectedItems.length !== 2);
        }

        function checkAnswer() {
            const isCorrect = selectedItems.every(item => item.correct) && selectedItems.length === 2;
            
            if (isCorrect) {
                document.getElementById('scroll-area').style.display = 'none';
                currentGate++;
                updateGatesUI();
                
                if (currentGate > 4) {
                    finishGame();
                } else {
                    document.getElementById('wait-message').style.display = 'block';
                    showModal(
                        "–û—Ç–ª–∏—á–Ω–æ!", 
                        "–ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! –¢–µ–ø–µ—Ä—å –∂–¥–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π —É—á–∏—Ç–µ–ª—è.", 
                        false, 
                        null, null, 
                        "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å", null, 
                        "fa-star"
                    );
                }
            } else {
                showModal("–û—à–∏–±–∫–∞", "–≠—Ç–æ –Ω–µ —Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã. –ü–µ—Ä–µ—á–∏—Ç–∞–π—Ç–µ —Ç–µ–∫—Å—Ç!", false, null, null, "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞", null, "fa-times-circle");
                // Reset selection
                document.querySelectorAll('.game-item').forEach(el => el.classList.remove('selected'));
                selectedItems = [];
                document.getElementById('check-btn').disabled = true;
            }
        }

        function finishGame() {
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('end-screen').style.display = 'block';
            createConfetti();
            fetchWishes();
        }

        function createConfetti() {
            for (let i = 0; i < 100; i++) {
                const conf = document.createElement('div');
                conf.className = 'confetti';
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.animationDuration = (Math.random() * 2 + 2) + 's';
                conf.style.backgroundColor = ['#d4af37', '#4a0404', '#fff', '#8b4513'][Math.floor(Math.random()*4)];
                document.body.appendChild(conf);
                setTimeout(() => conf.remove(), 4000);
            }
        }

        function addEmoji(emoji) {
            const textarea = document.getElementById('student-wish');
            textarea.value += emoji;
        }

        function submitWish() {
            const name = document.getElementById('student-name').value.trim();
            const wish = document.getElementById('student-wish').value.trim();

            if (!name || !wish) {
                showModal("–ü–æ–¥–æ–∂–¥–∏—Ç–µ", "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è –∏ –ø–æ–∂–µ–ª–∞–Ω–∏–µ.", false, null, null, "–ù–∞–∑–∞–¥", null, "fa-pen");
                return;
            }

            showModal("–û—Ç–ø—Ä–∞–≤–∫–∞...", "–°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∞—à–µ –ø–æ–∂–µ–ª–∞–Ω–∏–µ...", false, null, null, null, null, "fa-spinner fa-spin");

            const formData = new FormData();
            formData.append('action', 'submitResponse');
            formData.append('sheetName', SHEET_NAME);
            formData.append('fields', JSON.stringify(['◊©◊ù ◊î◊™◊ú◊û◊ô◊ì◊î', '◊ê◊ô◊ó◊ï◊ú']));
            formData.append('◊©◊ù ◊î◊™◊ú◊û◊ô◊ì◊î', name);
            formData.append('◊ê◊ô◊ó◊ï◊ú', wish);

            fetch(SCRIPT_URL, { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    hideModal();
                    if (data.status === 'success') {
                        document.getElementById('student-wish').value = '';
                        fetchWishes();
                        showModal("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!", "–í–∞—à–µ –ø–æ–∂–µ–ª–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∏ —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è –Ω–∞ –¥–æ—Å–∫–µ.", false, null, null, "–ó–∞–∫—Ä—ã—Ç—å", null, "fa-check");
                    } else {
                        throw new Error("◊©◊í◊ô◊ê◊î ◊ë◊©◊û◊ô◊®◊î");
                    }
                })
                .catch(err => {
                    hideModal();
                    showModal("–û—à–∏–±–∫–∞", "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.", false, null, null, "–ó–∞–∫—Ä—ã—Ç—å", null, "fa-exclamation-triangle");
                });
        }

        function fetchWishes() {
            const list = document.getElementById('wishes-list');
            
            fetch(`${SCRIPT_URL}?action=getResponses&sheetName=${encodeURIComponent(SHEET_NAME)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success' && data.responses.length > 0) {
                        list.innerHTML = '';
                        // Reverse to show newest first
                        data.responses.reverse().forEach(item => {
                            const commenter = item['◊©◊ù ◊î◊™◊ú◊û◊ô◊ì◊î'] || '–ì–æ—Å—Ç—å';
                            const text = item['◊ê◊ô◊ó◊ï◊ú'] || '';
                            
                            if(text) {
                                const div = document.createElement('div');
                                div.className = 'wish-card';
                                div.innerHTML = `<div class="wish-author">${commenter} –ø–æ–∂–µ–ª–∞–ª–∞:</div><div>${text}</div>`;
                                list.appendChild(div);
                            }
                        });
                    } else {
                        list.innerHTML = '–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–∂–µ–ª–∞–Ω–∏–π. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º–∏!';
                    }
                })
                .catch(err => {
                    list.innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∂–µ–ª–∞–Ω–∏–π.';
                });
        }
    </script>
</body>
</html>